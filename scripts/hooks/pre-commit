#!/bin/bash
#
# Pre-commit hook: Prompt before committing on protected branches
#
# This hook prevents accidental commits on main by requiring confirmation.

# Protected branches that require confirmation
PROTECTED_BRANCHES="main master"

# Get current branch
current_branch=$(git rev-parse --abbrev-ref HEAD)

# Check if we're on a protected branch
for protected in $PROTECTED_BRANCHES; do
    if [ "$current_branch" = "$protected" ]; then
        echo ""
        echo "⚠️  You're about to commit directly to '$current_branch'"
        echo ""
        echo "The recommended workflow is:"
        echo "  1. Create a feature branch: git checkout -b feature/my-change"
        echo "  2. Make your changes and commit there"
        echo "  3. Push and create a PR to staging"
        echo ""

        # Check if we're in an interactive terminal
        if [ -t 0 ]; then
            read -p "Are you sure you want to commit to $current_branch? (yes/no): " confirm
            if [ "$confirm" != "yes" ]; then
                echo ""
                echo "Commit cancelled. To create a branch instead:"
                echo "  git stash"
                echo "  git checkout -b feature/my-change"
                echo "  git stash pop"
                exit 1
            fi
            echo "Proceeding with commit to $current_branch..."
        else
            echo "Non-interactive shell detected. To commit to $current_branch, run:"
            echo "  git commit --no-verify"
            echo ""
            echo "Commit cancelled."
            exit 1
        fi
    fi
done

exit 0
